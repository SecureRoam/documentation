# iptables

iptables is a firewall that allows you to configure rules to filter network traffic. It is a free and open-source software that runs on a Raspberry Pi or any other Linux-based system.

## Basic concepts

iptables uses a set of tables, chains, and rules to filter network traffic. The following diagram shows how packets are processed by iptables:

```md
                               XXXXXXXXXXXXXXXXXX
                             XXX     Network    XXX
                               XXXXXXXXXXXXXXXXXX
                                       +
                                       |
                                       v
 +-------------+              +------------------+
 |table: filter| <---+        | table: nat       |
 |chain: INPUT |     |        | chain: PREROUTING|
 +-----+-------+     |        +--------+---------+
       |             |                 |
       v             |                 v
 [local process]     |           ****************          +--------------+
       |             +---------+ Routing decision +------> |table: filter |
       v                         ****************          |chain: FORWARD|
****************                                           +------+-------+
Routing decision                                                  |
****************                                                  |
       |                                                          |
       v                        ****************                  |
+-------------+       +------>  Routing decision  <---------------+
|table: nat   |       |         ****************
|chain: OUTPUT|       |               +
+-----+-------+       |               |
      |               |               v
      v               |      +-------------------+
+--------------+      |      | table: nat        |
|table: filter | +----+      | chain: POSTROUTING|
|chain: OUTPUT |             +--------+----------+
+--------------+                      |
                                      v
                               XXXXXXXXXXXXXXXXXX
                             XXX    Network     XXX
                               XXXXXXXXXXXXXXXXXX
```

### Tables

iptables has five built-in tables:

1. `raw` - This table is used for configuring packets before they are processed by the connection tracking system.
2. `filter` - This table is used for filtering packets.
3. `nat` - This table is used for network address translation (NAT).
4. `mangle` - This table is used for specialized packet alteration.
5. `security` - This table is used for Mandatory Access Control (MAC) networking rules.

Usually, you will only need to work with the `filter` and `nat` tables.

### Chains

Tables contain chains, which are lists of rules that are processed in order. The built-in chains for the `filtrer` table are:

1. `INPUT` - This chain is used for packets destined for the local system.
2. `OUTPUT` - This chain is used for packets originating from the local system.
3. `FORWARD` - This chain is used for packets being routed through the system.

The built-in chains for the `nat` table are:

1. `PREROUTING` - This chain is used for packets as they come into the system.
2. `POSTROUTING` - This chain is used for packets as they leave the system.
3. `OUTPUT` - This chain is used for packets generated by the local system.

### Rules

Rules are used to define how packets should be handled. A rule consists of a match and a target. The match specifies the conditions that a packet must meet to match the rule, and the target specifies what action should be taken if the packet matches the rule.

For example, the following rule allows incoming traffic on port 80:

```bash
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
```

In this rule:

- `-A INPUT` specifies that the rule should be added to the `INPUT` chain.
- `-p tcp` specifies that the rule should match TCP packets.
- `--dport 80` specifies that the rule should match packets with a destination port of 80.
- `-j ACCEPT` specifies that packets that match the rule should be accepted.

Built-in targets include:

- `ACCEPT` - Accept the packet.
- `DROP` - Drop the packet. No reply is sent.
- `REJECT` - Reject the packet with an error message.
- `LOG` - Log the packet.
- `RETURN` - Return to the calling chain.

## Default configuration file

By default, Secure Roam Companion drops all incoming ICMP echo requests (ping) and allows incoming HTTP and HTTPS.

Secure Roam Companion uses the following default configuration file for iptables:

```bash
#!/bin/bash

iptables-restore < /etc/iptables.test.rules

# Flush all existing rules
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X

# Block all incoming ICMP echo requests (ping)
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# Allow all related and established connections
iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Allow incoming HTTP and HTTPS
iptables -A INPUT -p tcp -i wlan0 --dport 80 -j ACCEPT
iptables -A INPUT -p tcp -i wlan0 --dport 443 -j ACCEPT

# If no rule matched, drop the packet
iptables -P INPUT DROP
```
